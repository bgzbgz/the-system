!function(){"use strict";var e="http://localhost:3000",t="ft_visitor_id",r="ft_response_queue",n={},s={get:function(e){try{var t=localStorage.getItem(e);return null!==t?t:n[e]}catch(t){return n[e]}},set:function(e,t){try{localStorage.setItem(e,t)}catch(r){n[e]=t}},getJ:function(e){try{var t=this.get(e);return t?JSON.parse(t):null}catch(e){return null}},setJ:function(e,t){try{this.set(e,JSON.stringify(t))}catch(r){n[e]=t}}};function i(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function o(e){try{return new URLSearchParams(location.search).get(e)}catch(e){return null}}function u(e){var t=new WeakSet;return JSON.parse(JSON.stringify(e,function(e,r){if("object"==typeof r&&null!==r){if(t.has(r))return;t.add(r)}return r}))}var c={_init:!1,_ctx:null,_id:null,_slug:function(){try{var e=document.querySelector('meta[name="ft-tool-slug"]');if(e&&e.content)return e.content}catch(e){}try{var t=location.pathname.match(/\/tools\/([^/]+)/);if(t&&t[1])return t[1]}catch(e){}try{var r=document.body.getAttribute("data-tool-slug");if(r)return r}catch(e){}return null},_capture:function(){try{var e={visitorId:s.get(t),source:"direct"};e.visitorId||(e.visitorId=i(),s.set(t,e.visitorId));var r=o("ft_token");if(r){var n=function(e){try{var t=e.split(".");return 3!==t.length?null:JSON.parse(atob(t[1].replace(/-/g,"+").replace(/_/g,"/")))}catch(e){return null}}(r);n&&(e.lwId=n.user_id||n.sub,e.name=n.user_name||n.name,e.email=n.user_email||n.email,e.course=n.course_id,e.lesson=n.lesson_id)}return e.lwId||(e.lwId=o("user_id")||o("lw_user_id")),e.name||(e.name=o("user_name")||o("name")),e.email||(e.email=o("user_email")||o("email")),e.course||(e.course=o("course_id")),e.lesson||(e.lesson=o("lesson_id")),e.ref=document.referrer||null,e.lwId||e.ref&&-1!==e.ref.indexOf("learnworlds")?e.source="learnworlds":window!==window.top?e.source="embed":(o("share")||e.ref&&/facebook|twitter|linkedin|whatsapp/i.test(e.ref))&&(e.source="share"),e}catch(e){return console.warn("[FT] Identity error"),{visitorId:i(),source:"direct"}}},_queue:function(e,t){try{var n=s.getJ(r)||[];for(n.push({p:e,t:Date.now(),s:t});n.length>10;)n.shift();return s.setJ(r,n),!0}catch(e){return!1}},_flush:function(){try{var t=s.getJ(r)||[];if(!t.length)return;console.log("[FT] Flushing",t.length,"queued");var n=[];Promise.all(t.map(function(t){return fetch(e+"/api/tools/"+t.s+"/responses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.p)}).then(function(e){e.ok||n.push(t)}).catch(function(){n.push(t)})})).then(function(){s.setJ(r,n)})}catch(e){}},init:function(t){try{return t=t||{},this._ctx={slug:t.slug||this._slug(),ver:t.version||"1.0.0",api:t.apiBase||e},this._id=this._capture(),this._init=!0,this._flush(),console.log("[FT] Init:",this._ctx.slug||"(none)","|",this._id.visitorId),this}catch(e){return console.warn("[FT] Init failed"),this._init=!1,this}},submit:function(e,t,r){var n=this;return r=r||{},new Promise(function(s){try{if(!n._ctx||!n._ctx.slug)return console.error("[FT] No slug"),r.onError&&r.onError(new Error("No slug")),s({success:!1,error:"No slug",queued:!1});var i={visitorId:n._id.visitorId,userName:n._id.name,userEmail:n._id.email,learnworldsUserId:n._id.lwId,inputs:u(e),result:u(t),source:n._id.source,courseId:n._id.course,lessonId:n._id.lesson,referrer:n._id.ref,toolVersion:n._ctx.ver};fetch(n._ctx.api+"/api/tools/"+n._ctx.slug+"/responses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(function(e){if(e.ok)return e.json().then(function(e){console.log("[FT] Submitted:",e.id),r.onSuccess&&r.onSuccess({id:e.id,visitorId:n._id.visitorId}),s({success:!0,responseId:e.id})});throw new Error("API "+e.status)}).catch(function(e){console.warn("[FT] Submit failed");var t=n._queue(i,n._ctx.slug);r.onError&&r.onError(e),s({success:!1,error:e.message,queued:t})})}catch(e){console.warn("[FT] Submit error"),r.onError&&r.onError(e),s({success:!1,error:e.message,queued:!1})}})},getVisitor:function(){try{return{visitorId:this._id.visitorId,source:this._id.source,userName:this._id.name,userEmail:this._id.email,learnworldsUserId:this._id.lwId,courseId:this._id.course,lessonId:this._id.lesson,referrer:this._id.ref}}catch(e){return{visitorId:i(),source:"direct"}}}};function a(){c._init||c.init()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),window.FastTrackTool=c}();